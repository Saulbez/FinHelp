<%- include('partials/header.ejs') %>
<main>
    <div class="container mt-4">
      <h2 class="mb-4">Registrar Venda</h2>
      
      <div class="row">
        <!-- Formulário -->
        <div class="col-md-6">
          <form id="saleForm">
            <div class="mb-3">
              <label class="form-label">Cliente</label>
              <select class="form-select" id="clientSelect" required>
                <option value="">Selecione...</option>
                <% clients.forEach(client => { %>
                  <option value="<%= client.id %>"><%= client.name %></option>
                <% }) %>
              </select>
            </div>
  
            <div class="mb-3">
              <label class="form-label">Produtos</label>
              <select class="form-select" id="productSelect" multiple>
                <% products.forEach(product => { %>
                  <option value="<%= product.id %>" data-price="<%= product.price %>">
                    <%= product.name %> - R$ <%= Number(product.price).toFixed(2) %>
                  </option>
                <% }) %>
              </select>
            </div>
  
            <div class="mb-3">
              <label class="form-label">Forma de Pagamento</label>
              <select class="form-select" id="paymentMethod">
                <option value="1">À Vista</option>
                <option value="3">3x com Juros</option>
                <option value="6">6x com Juros</option>
              </select>
            </div>
  
            <div class="alert alert-info">
              Total: R$ <span id="totalAmount">0.00</span>
            </div>
  
            <button type="submit" class="btn btn-success">Registrar Venda</button>
          </form>
        </div>
  
        <!-- Calculadora de Juros -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Simulador de Juros</h5>
              <div class="mb-3">
                <input type="number" class="form-control" id="simulatorAmount" placeholder="Valor">
              </div>
              <div class="mb-3">
                <select class="form-select" id="simulatorInstallments">
                  <option value="1">1x</option>
                  <option value="3">3x</option>
                  <option value="6">6x</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="calculateInterest()">Calcular</button>
              <div class="mt-3" id="simulatorResult"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script defer="defer">
    // Cálculo Dinâmico
    const updateTotal = () => {
      let total = 0;
      document.querySelectorAll('#productSelect option:checked').forEach(option => {
        total += parseFloat(option.dataset.price);
      });
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    };
  
    document.getElementById('productSelect').addEventListener('change', updateTotal);
        function calculateInterest() {
        const amount = parseFloat(document.getElementById('simulatorAmount').value);
        const installments = parseInt(document.getElementById('simulatorInstallments').value);
        const interestRate = 2.5; // 2.5% ao mês
        const total = amount * Math.pow(1 + (interestRate / 100), installments);

        document.getElementById('simulatorResult').innerHTML = `
        Total: R$ ${total.toFixed(2)}<br>
        Parcelas: ${installments}x de R$ ${(total / installments).toFixed(2)}
        `;
    }

    document.getElementById('saleForm').addEventListener('submit', async (e) => {
    e.preventDefault();

        const selectedProducts = Array.from(document.querySelectorAll('#productSelect option:checked'))
        .map(option => ({
            id: option.value,
            quantity: 1 // Altere para um campo de quantidade se necessário
        }));

        try {
            const response = await fetch('/vendas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                client_id: document.getElementById('clientSelect').value,
                products: selectedProducts,
                payment_method: document.getElementById('paymentMethod').value
            })
        });

        if (response.ok) {
            window.location.href = '/vendas'; // Recarrega após sucesso
        }
        } catch (err) {
            console.error('Erro:', err);
        }
    });
  </script>
  <%- include('partials/footer.ejs') %>