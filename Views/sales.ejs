<%- include('partials/header.ejs') %>

<main class="container my-4 px-md-5">
    <!-- Botão Nova Venda -->
    <div class="text-end my-4">
        <button class="btn btn-success btn-lg rounded-pill" id="showNewSaleForm">
            <i class="bi bi-plus-circle me-2"></i>Nova Venda
        </button>
    </div>
    <div id="errorContainer"></div>

    <% if(products.length > 0) { %>
      <!-- Formulário de Nova Venda (Oculto inicialmente) -->
      <div class="card shadow-sm mb-5 d-none" id="newSaleForm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cart-plus me-2"></i>Nova Venda</h5>
        </div>
                  <div class="card-body">
                      <form id="saleForm">
                          <!-- Cliente e Data -->
                          <div class="row g-3 mb-4">
                              <div class="col-md-6">
                                  <label class="form-label">Cliente</label>
                                  <select class="form-select" id="clientSelect" required>
                                      <option value="">Selecione um cliente...</option>
                                      <% clients.forEach(client => { %>
                                      <option value="<%= client.id %>"><%= client.name %></option>
                                      <% }) %>
                                  </select>
                              </div>
                              <div class="col-md-6">
                                  <label class="form-label">Data da Venda</label>
                                  <input type="datetime-local" class="form-control" id="saleDate" 
                                        value="<%= new Date().toISOString().slice(0,16) %>" required>
                              </div>
                          </div>

                          <!-- Itens da Venda -->
                          <div class="mb-4">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                  <h6>Itens da Venda</h6>
                                  <div>
                                      <button type="button" class="btn btn-sm btn-outline-success me-2" id="addProductBtn">
                                          <i class="bi bi-plus-circle"></i> Adicionar
                                      </button>
                                      <button type="button" class="btn btn-sm btn-outline-primary" id="applyCampaignBtn">
                                          <i class="bi bi-percent"></i> Aplicar Campanha
                                      </button>
                                  </div>
                              </div>
                              <div id="productsContainer" class="mb-4">
                                  <!-- Itens serão adicionados dinamicamente -->
                              </div>
                          </div>

                          <!-- Pagamento -->
                          <div class="mb-4">
                              <h6 class="mb-3">Forma de Pagamento</h6>

                              <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="togglePaymentMethod">
                                <label class="form-check-label" for="togglePaymentMethod">Usar duas formas de pagamento</label>
                            </div>

                              <div class="d-flex justify-content-start payment-methods-container">
                                  <div class="row g-3 payment-methods">
                                      <!-- Método 1 -->
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <select class="form-select payment-method" data-index="1" required>
                                                    <option value="">Selecione...</option>
                                                    <option value="dinheiro">Dinheiro</option>
                                                    <option value="pix">PIX</option>
                                                    <option value="debito">Cartão Débito</option>
                                                    <option value="credito">Cartão Crédito</option>
                                                    <option value="pix_credito">PIX Crédito</option>
                                                </select>
                                                <input type="text" class="form-control payment-amount active-payment" name="payment_1" data-index="1" required readonly>
                                            </div>
                                            <div class="mt-2">
                                                <div class="method-total text-end small" data-index="1"></div>
                                                <div class="interest-detail text-danger small" data-index="1"></div>
                                            </div>
                                            <div class="interest-field mt-2" data-index="1" style="display: none;">
                                                <div class="input-group">
                                                    <span class="input-group-text">Juros (%)</span>
                                                    <input type="number" class="form-control interest-rate" step="0.01" min="0" max="50" value="2.99" name="interest_rate_1" required>
                                                    <span class="input-group-text">
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip"
                                                        title="Juros cobrado apenas sobre este valor"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <!-- Novo campo para parcelas -->
                                            <div class="input-group mt-2">
                                                <span class="input-group-text">Parcelas</span>
                                                <input type="number" class="form-control installments" data-index="1" min="1" value="1" required>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input payment-status" type="checkbox" data-index="1" id="paymentStatus1">
                                                <label class="form-check-label" for="paymentStatus1">Pago</label>
                                            </div>

                                        <!-- Método 2 (similar, com data-index="2") -->
                                        <div class="col-md-6 d-none" id="paymentMethod2">
                                            <div class="input-group">
                                                <select class="form-select payment-method" data-index="2">
                                                    <option value="">Segunda forma (opcional)</option>
                                                    <option value="dinheiro">Dinheiro</option>
                                                    <option value="pix">PIX</option>
                                                    <option value="debito">Cartão Débito</option>
                                                    <option value="credito">Cartão Crédito</option>
                                                    <option value="pix_credito">PIX Crédito</option>
                                                </select>
                                                <input type="text" class="form-control payment-amount" name="payment_2" data-index="2" placeholder="Valor" inputmode="decimal">
                                            </div>
                                            <div class="mt-2">
                                                <div class="method-total text-end small" data-index="2"></div>
                                                <div class="interest-detail text-danger small" data-index="2"></div>
                                            </div>
                                            <div class="interest-field mt-2" data-index="2" style="display: none;">
                                                <div class="input-group">
                                                    <span class="input-group-text">Juros (%)</span>
                                                    <input type="number" class="form-control interest-rate" step="0.01" min="0" max="50" value="2.99" name="interest_rate_2" required>
                                                </div>
                                            </div>
                                            <!-- Novo campo para parcelas -->
                                            <div class="input-group mt-2">
                                                <span class="input-group-text">Parcelas</span>
                                                <input type="number" class="form-control installments" data-index="2" min="1" value="1" required>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input payment-status" type="checkbox" data-index="2" id="paymentStatus2">
                                                <label class="form-check-label" for="paymentStatus1">Pago</label>
                                            </div>
                                        </div>
                                    </div>
                                  </div>
                              </div>
                          </div>

                          <!-- Resumo -->
                          <div class="card border-success mb-4">
                              <div class="card-body">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="h5 mb-3">Subtotal: <span id="subtotal">R$ 0,00</span></div>
                                          <div class="text-muted small" id="discountInfo"></div>
                                      </div>
                                      <div class="col-md-6 text-end">
                                          <div id="totalRaw" style="display: none;"><%= 0.00.toFixed(2) %></div>
                                          <div class="h4 text-success">Total: <span id="totalAmount">R$ 0,00</span></div>
                                          <div class="text-muted small" id="interestSummary"></div>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <button type="submit" class="btn btn-success w-100 py-3">
                              <i class="bi bi-check-circle me-2"></i>Finalizar Venda
                          </button>
                      </form>
                  </div>
              </div>
            <% } else { %>
              <div class="alert alert-warning mt-4">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Nenhum produto disponível para venda. Cadastre produtos primeiro.
              </div>
            <% } %>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <select class="form-select" id="filterProduct">
                        <option value="">Todos Produtos</option>
                        <% products.forEach(p => { %>
                            <option value="<%= p.id %>"><%= p.name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" id="filterMinPrice" placeholder="Preço Mínimo">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterPayment">
                        <option value="">Todos Pagamentos</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">PIX</option>
                        <option value="debito">Cartão Débito</option>
                        <option value="credito">Cartão Crédito</option>
                        <option value="pix_credito">PIX Crédito</option>
                    </select>
                </div>
            </div>
              <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Últimas Vendas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Produtos</th>
                                    <th>Pagamento</th>
                                    <th>Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentSales.forEach(sale => { %>
                                <tr>
                                    <td><%= new Date(sale.sale_date).toLocaleDateString('pt-BR') %></td>
                                    <td><%= sale.client_name || 'Não informado' %></td>
                                    <td>
                                        <% sale.products.forEach(product => { %>
                                        <div class="badge bg-secondary me-1">
                                            <%= product.quantity %>x <%= product.name %>
                                        </div>
                                        <% }) %>
                                    </td>
                                    <td>
                                        <% sale.payment_methods.forEach(method => { %>
                                        <div class="badge bg-info me-1 mb-1">
                                            <%= method.method %>: R$ <%= Number(method.amount).toFixed(2) %>
                                        </div>
                                        <% }) %>
                                    </td>
                                    <td class="fw-bold">R$ <%= Number(sale.total).toFixed(2) %></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                            onclick="loadSale('<%= sale.id %>')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="deleteSale('<%= sale.id %>')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal de edição de venda -->
            <div class="modal fade" id="editSaleModal" tabindex="-1" aria-labelledby="editSaleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                <form id="editSaleForm">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editSaleModalLabel">Editar Venda</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Campos semelhantes ao formulário de nova venda -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Cliente</label>
                                <select class="form-select" id="editClientSelect" required>
                                    <option value="">Selecione um cliente...</option>
                                    <% clients.forEach(client => { %>
                                    <option value="<%= client.id %>"><%= client.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data da Venda</label>
                                <input type="datetime-local" class="form-control" id="editSaleDate" required>
                            </div>
                        </div>
                        <!-- Aqui você pode replicar os blocos de produtos e pagamentos -->
                        <div id="editProductsContainer"></div>
                        <div id="editPaymentsContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Salvar Alterações</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                    </div>
                </form>
                </div>
            </div>
      </main>
      
      <%- include('partials/footer.ejs') %>