<%- include('partials/header.ejs') %>

<!-- <main>
    <div class="tables-wrapper">
        <h2>Clientes Cadastrados</h2>
        <table class="clients-table">
            <tr>
                <th>Clientes</th>
                <th>Contato</th>
                <th>Ações</th>
                <th>Última Compra</th>
            </tr>
            <tr>
                <td>João Bezerra</td>
                <td>(85) 98888-8888</td>
                <td><button>...</button></td>
                <td>Quasar Fire</td>
            </tr>
            <tr>
                <td>Saul Bezerra</td>
                <td>(85) 98888-8888</td>
                <td><button>...</button></td>
                <td>Essencial Supreme</td>
            </tr>
            <tr>
                <td>Samuel Coelho</td>
                <td>(85) 98888-8888</td>
                <td><button>...</button></td>
                <td>Egeo Blue</td>
            </tr>
            <tr>
                <td>Amanda Paolino</td>
                <td>(85) 98888-8888</td>
                <td><button>...</button></td>
                <td>Lily</td>
            </tr>
            <tr>
                <td>Késsia Oliveira</td>
                <td>(85) 98888-8888</td>
                <td><button>...</button></td>
                <td>Club 6</td>
            </tr>
        </table>
    </div>
</main>

</body>
</html> -->

<!-- Modal de Edição -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Editar Cliente</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" id="editClientId">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <input type="tel" class="form-control" id="editPhone">
                    </div>
                    <div class="mb-3">
                        <input type="number" class="form-control" id="editDebt" step="0.01">
                    </div>
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Histórico -->
<div class="modal fade" id="historyModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Histórico do Cliente</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Produtos</th>
                        </tr>
                    </thead>
                    <tbody id="historyContent">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<main>
    <div class="container mt-4">
    <!-- Barra de Ferramentas -->
        <div class="d-flex justify-content-between mb-4">
            <h2>Clientes</h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                + Novo Cliente
                </button>
            </div>
        </div>

    <!-- Tabela Responsiva -->
        <div class="table-responsive">
            <table class="table-hover clients-table">
                <thead>
                <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Última Compra</th>
                    <th>Débito</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody>
                <% clients.forEach(client => { %>
                    <tr>
                    <td><%= client.name %></td>
                    <td><%= client.phone %></td>
                    <td><%= new Date(client.last_purchase).toLocaleDateString() %></td>
                    <td class="<%= client.debt > 0 ? 'text-danger' : 'text-success' %>">
                        R$ <%= Number(client.debt).toFixed(2) %>
                    </td>
                    <td>
                        <button class="btn btn-edit btn-sm" 
                                onclick='openEditModal(" <%=client.id%> ")'>Editar</button>
                        
                        <button class="btn btn-history btn-sm" 
                                onclick='openHistoryModal("<%=client.id%>")''>Histórico</button>
                                
                        <button class="btn btn-delete btn-sm" 
                                onclick="confirmDelete('<%=client.id%>')">Excluir</button>
                    </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </div>

<!-- Modal Adicionar Cliente -->
    <div class="modal fade" id="addClientModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">Novo Cliente</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/clientes" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                    <input type="text" class="form-control" name="name" placeholder="Nome Completo" required>
                    </div>
                    <div class="mb-3">
                    <input type="tel" class="form-control" name="phone" placeholder="Telefone" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
                </form>
            </div>
        </div>
    </div>
</main>

    <script defer="defer">
    // Editar Cliente
        async function openEditModal(clientId) {
        
            try {
                console.log("Abrindo edição para:", clientId);
                const response = await fetch(`/clientes/${clientId}`);
                const client = await response.json();
                
                document.getElementById('editClientId').value = client.id;
                document.getElementById('editName').value = client.name;
                document.getElementById('editPhone').value = client.phone;
                document.getElementById('editDebt').value = client.debt;
                
                new bootstrap.Modal('#editModal').show();
            } catch (err) {
                console.error("Falha ao buscar cliente:", err);
                alert("Não foi possível carregar os dados do cliente");
            }
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const updatedClient = {
            name: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            debt: document.getElementById('editDebt').value
            };

            await fetch(`/clientes/${document.getElementById('editClientId').value}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedClient)
            });

            location.reload();
        });

        // Histórico de Compras
        async function openHistoryModal(clientId) {
            const response = await fetch(`/clientes/${clientId}/historico`);
            const history = await response.json();
            
            const historyHTML = history.map(sale => `
            <tr>
                <td>${new Date(sale.sale_date).toLocaleDateString()}</td>
                <td>R$ ${sale.total.toFixed(2)}</td>
                <td>${sale.products.join(', ')}</td>
            </tr>
            `).join('');
            
            document.getElementById('historyContent').innerHTML = historyHTML;
            new bootstrap.Modal('#historyModal').show();
        }

        // Excluir Registros
        async function confirmDelete(id) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
            await fetch(`/clientes/${id}`, { method: 'DELETE' });
            location.reload();
            }
        }
    </script>
<%- include('partials/footer.ejs') %>